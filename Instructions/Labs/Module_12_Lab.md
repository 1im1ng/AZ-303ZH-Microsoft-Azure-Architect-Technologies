---
lab:
    title: '12: 使用 Azure Site Recovery 保护 Hyper-V VM'
    module: '模块 12：在 Azure 中管理工作负载'
---

# 实验室：使用 Azure Site Recovery 保护 Hyper-V VM
# 学生实验室手册

## 实验室场景

尽管 Adatum 公司多年来已对其本地工作负载实现许多高可用性预配，但其灾难恢复功能仍不足以满足其业务所需的恢复点目标 (RPO) 和恢复时间目标 (RTO)。维护现有的辅助本地站点需要大量的工作，并且会产生巨大的成本。故障转移和故障回复过程在大多数情况下是手动的，并且记录不充分。 

为了解决这些不足之处，Adatum 企业体系结构团队决定探索 Azure Site Recovery 的功能，利用 Azure 充当辅助站点的托管者。Azure Site Recovery 自动、连续地将物理机和虚拟机上运行的工作负载从主站点复制到辅助站点。Site Recovery 使用基于存储的复制机制，而不会拦截应用程序数据。将 Azure 作为辅助站点，数据以内置方式存储在 Azure 存储中，不仅灵活，而且成本低。故障转移后，使用复制的数据对目标 Azure VM 进行水化处理。由于 Site Recovery 为 VMware VM 提供连续复制，而且 Hyper-V VM 的复制频率低至 30 秒，这使恢复时间目标 (RTO) 和恢复点目标得以最小化。此外，Azure Site Recovery 还可处理故障转移和故障回复过程的业务流程，这些过程在很大程度上可以自动化。还可使用 Azure Site Recovery 执行到 Azure 的迁移，不过推荐的方法依赖于 Azure Migrate。

Adatum Enterprise 体系结构团队希望评估将用于保护本地 Hyper-V 虚拟机的 Azure Site Recovery 用于 Azure VM 的情况。

## 目标
  
完成本实验室后，你将能够：

-  配置 Azure Site Recovery

-  执行测试故障转移

-  执行计划的故障转移

-  执行未计划的故障转移


## 实验室环境

Windows Server 管理员凭据

-  用户名： **Student**

-  密码：**Pa55w.rd1234**

预计用时：120 分钟


## 实验室文件

-  \\\\AZ303\\AllFiles\\Labs\\12\\azuredeploy30312suba.json


### 练习 0：准备实验室环境

本次练习的主要任务如下：

1. 请使用 Azure 资源管理器快速启动模板部署 Azure VM

1. 在 Azure VM 中配置嵌套虚拟化


#### 任务 1：请使用 Azure 资源管理器快速启动模板部署 Azure VM

1. 在实验室计算机上，启动 Web 浏览器，导航至 [“Azure 门户”](https://portal.azure.com)，然后通过提供要在本实验中使用的订阅中的所有者角色的用户帐户凭据来登录。

1. 在 Azure 门户中，通过直接选择搜索文本框右侧的工具栏图标打开 **“Cloud Shell”** 窗格。

1. 提示选择 **“Bash”** 或 **“PowerShell”** 时，选择 **“PowerShell”**。 

    >**注意**：如果这是你第一次打开 **“Cloud Shell”**，会看到 **“未装载任何存储”** 消息，请选择你在本实验室中使用的订阅，然后选择 **“创建存储”**。 

1. 在“Cloud Shell”窗格的工具栏中，选择 **“上传/下载文件”** 图标，在下拉菜单中选择 **“上传”**，然后将文件 **\\\\AZ303\\AllFiles\Labs\\12\\azuredeploy30312suba.json** 上传到 Cloud Shell 主目录中。

1. 在 Cloud Shell 窗格中，通过运行以下命令创建资源组（用订阅中可用于部署 Azure VM 且最接近实验室计算机位置的 Azure 区域的名称替换 `<Azure region>` 占位符）：

   ```powershell
   $location = '<Azure region>'
   New-AzSubscriptionDeployment `
     -Location $location `
     -Name az30312subaDeployment `
     -TemplateFile $HOME/azuredeploy30312suba.json `
     -rgLocation $location `
     -rgName 'az30312a-labRG'
   ```

      > **备注**：若要标识可在其中预配 Azure VM 的 Azure 区域，请参阅 [**https://azure.microsoft.com/zh-cn/regions/offers/**](https://azure.microsoft.com/zh-cn/regions/offers/)

1. 在 Azure 门户中，关闭 **“Cloud Shell”** 窗格。

1. 在实验室计算机上，打开另一个浏览器选项卡，导航到 [“虚拟网络中的 301 嵌套虚拟机 Azure 快速启动模板”](https://github.com/Azure/azure-quickstart-templates/tree/master/301-nested-vms-in-virtual-network)，然后选择 **“部署到 Azure”**。这将自动将浏览器重定向到 Azure 门户中的 **“具有嵌套 VM 的 Hyper-V 主机虚拟机”** 边栏选项卡。

1. 在 Azure 门户中 **“具有嵌套 VM 的 Hyper-V 主机虚拟机”** 边栏选项卡上，指定以下设置（将其他设置保留为其默认值）：

    | 设置 | 数值 | 
    | --- | --- |
    | 订阅 | 在本实验室使用的 Azure 订阅的名称 |
    | 资源组 | **az30312a-labRG** |
    | 主机公共 IP 地址名 | **az30312a-hv-vm-pip** |
    | 虚拟网络名 | **az30312a-hv-vnet** |
    | 主机网络界面 1 名 | **az30312a-hv-vm-nic1** |
    | 主机网络界面 2 名 | **az30312a-hv-vm-nic2** |
    | 主机虚拟机名 | **az30312a-hv-vm** |
    | 主机管理员用户名 | **Student** |
    | 主机管理员密码 | **Pa55w.rd1234** |

1. 在 **“具有嵌套 VM 的 Hyper-V 主机虚拟机”** 边栏选项卡上，选择 **“查看 + 创建”**，然后选择 **“创建”**。

    > **注意**：等待部署完成。该部署可能需要约 10 分钟。

#### 任务 2： 在 Azure VM 中配置嵌套虚拟化

1. 在 Azure 门户中，搜索并选择 **“虚拟机”**，然后在 **“虚拟机”** 边栏选项卡，选择 **“az30312a-hv-vm”**。

1. 在 **“az30312a-hv-vm”** 边栏选项卡中，选择 **“网络”**。 

1. 在 **“az30312a-hv-vm | 网络”** 边栏选项卡，选择 **“az30312a-hv-vm-nic1”** 然后选择 **“添加入站端口规则”**。

    >**注意**：确保你修改了 **“az30312a-hv-vm-nic1”** 的设置，该设置已为其分配公共 IP 地址。

1. 在 **“添加入站安全规则”** 边栏选项卡中，指定以下设置（将其他设置保留为默认值）并选择 **“添加”**：

    | 设置 | 数值 | 
    | --- | --- |
    | 目标端口范围 | **3389** |
    | 协议 | **任何** |
    | 名称 | **AllowRDPInBound** |

1. 在 **“az30312a-hv-vm”** 边栏选项卡中，选择 **“概述”**。 

1. 在 **“az30312a-hv-vm”** 边栏选项卡中，选择 **“连接”**，在下拉菜单中选择 **“RDP”**，然后单击 **“下载 RDP 文件”**。

1. 出现提示时，请使用以下凭据登录：

-  用户名：**Student**

-  密码：**Pa55w.rd1234**

1. 在与 **“az30312a-hv-vm”** 的远程桌面会话中，在“服务器管理器”窗口，单击 **“本地服务器”**，单击**IE 增强的安全配置**标签旁边的 **“开启”** 链接，并在 **“IE 增强的安全配置”** 对话框中，都选择 **“关闭”** 选项。

1. 在与 **“az30312a-hv-vm”** 的远程桌面会话中，启动 Internet Explorer，浏览至 [Windows Server Evaluations](https://www.microsoft.com/zh-cn/evalcenter/evaluate-windows-server-2019)，并下载 Windows Server 2019 **VHD** 文件到 **“F:\VHDs”** 文件夹（你需要先创建它）。 

1. 在与 **“az30312a-hv-vm”** 的远程桌面会话中，启动 **“Hyper-V 管理器”**。 

1. 在 **“Hyper-V 管理器”** 控制台中，选择 **“az30312a-hv-vm”** 节点，再选择 **“新建”**，然后在级联菜单中选择 **“虚拟机”**。这将启动 **“新建虚拟机向导”**。 

1. 在 **“新建虚拟机向导”** 的 **“开始之前”** 页面上，选择 **“下一步 >”**。

1. 在 **“新建虚拟机向导”** 的 **“指定名称和位置”** 页面上，指定以下设置并选择 **“下一步 >”**：

    | 设置 | 数值 | 
    | --- | --- |
    | 名称 | **az30312a-vm1** | 
    | 将虚拟机存储在其他位置 | 已选择 | 
    | 地点 | **F:\VMs** |

    >**注意**：务必创建 **F:\VMs** 文件夹。

1. 在 **“新建虚拟机向导”** 的 **“指定代数”** 页面上，确保选择了 **“第一代”** 选项，然后选择 **“下一步 >”**：

1. 在 **“新建虚拟机向导”** 的 **“分配内存”** 页面上，将 **“启动内存”** 设置为 **“2048”**，然后选择 **“下一步 >”**。

1. 在 **“新建虚拟机向导”** 的 **“配置网络”** 页面上， 在 **“连接”** 下拉列表中选择 **“NestedSwitch”**，然后选择 **“下一步 >”**。

1. 在 **“新建虚拟机向导”** 的 **“连接虚拟硬盘”** 页面上，选择 **“使用现有的虚拟硬盘”** 选项，将 VHD 文件下载到的位置设置为 **F:\VHDs** 文件夹，然后选择 **“下一步 >”**。

1. 在 **“新建虚拟机向导”** 的 **“摘要”** 页面上， 选择 **“完成”**。

1. 在 **“Hyper-V 管理器”** 控制台中，选择新创建的虚拟机，然后选择 **“启动”**。 

1. 在 **“Hyper-V 管理器”** 控制台中，确认虚拟机正在运行，然后选择 **“连接”**。 

1. 在 **az30312a-vm1** 的“虚拟机连接”窗口中的 **“你好”** 页面上，选择 **“下一步”**。 

1. 在 **az30312a-vm1**  的“虚拟机连接”窗口的 **“许可条款”** 页面上，选择 **“接受”**。 

1. 在到 **“az30312a-vm1”** 的虚拟机连接窗口，在 **“自定义设置”** 页面上，将内置管理员帐户的密码设置为 **“Pa55w.rd1234”**，然后选择 **“完成”**。 

1. 在到 **“az30312a-vm1”** 的虚拟机连接窗口，使用新设置的密码登录。

1. 在到 **“az30312a-vm1”** 的虚拟机连接窗口中，启动 Windows PowerShell，然后在 **“管理员：Windows PowerShell”** 窗口运行以下命令来设置计算机名。 

   ```powershell
   Rename-Computer -NewName 'az30312a-vm1' -Restart
   ```

### 练习 1：创建和配置 Azure Site Recovery 保管库
  
本次练习的主要任务如下：

1. 创建 Azure Site Recovery 保管库

1. 配置 Azure Site Recovery 保管库


#### 任务 1：创建 Azure Site Recovery 保管库

1. 在与 **“az30312a-hv-vm”** 的远程桌面会话中，启动 Internet Explorer，导航至 [“Azure 门户”](https://portal.azure.com)，然后通过提供你将在本实验室使用的订阅中具有所有者角色的用户帐户凭据来登录。

1. 在 Azure 门户中，搜索并选择 **“恢复服务保管库”**，然后在 **“恢复服务保管库”** 边栏选项卡上，选择 **“+ 添加”**。

1. 在 **“创建恢复服务保管库”** 边栏选项卡的 **“基本设置”** 选项卡上 ，指定以下设置（将其他设置保留为默认值）并选择 **“查看 + 创建”**：

    | 设置 | 数值 | 
    | --- | --- |
    | 订阅 | 在本实验室使用的 Azure 订阅的名称 |
    | 资源组 | 新资源组名称 **az30312b-labRG** |
    | 保管库名称 | **az30312b-rsvault** |
    | 地点 | 不同于之前在本实验室中将虚拟机部署到其中的 Azure 区域的名称 |

1. 在 **“创建恢复服务保管库”** 边栏选项卡的 **“查看 + 创建”** 选项卡中，选择 **“创建”**：

    >**注意**：默认情况下，“存储复制”类型的默认配置设置为“异地冗余 (GRS)”，并启用了“软删除”。你将在实验室中更改这些设置以简化取消预配，但应在生产环境中使用它们。


#### 任务 2： 配置 Azure Site Recovery 保管库

1. 在 Azure 门户中，搜索并选择 **“恢复服务保管库”**，然后在 **“恢复服务保管库”** 边栏选项卡中，选择 **“az30312b-rsvault”**。

1. 在 **“az30312b-rsvault”** 边栏选项卡中，选择 **“属性”**。 

1. 在 **“az30312b-rsvault | 属性”** 边栏选项卡中，在 **“备份配置”** 标签下选择 **“更新”** 链接。

1. 在 **“备份配置”** 边栏选项卡中，将 **“存储复制类型”** 设置为 **“本地冗余”**，选择 **“保存”**，然后关闭 **“备份配置”** 边栏选项卡。

    >**注意**：一旦启动保护项，就无法更改存储复制类型。

1. 在 **“az30312b-rsvault | 属性”** 边栏选项卡上，在 **“安全设置”** 标签下选择 **“更新”** 链接。

1. 在 **“安全设置”** 边栏选项卡上，将 **“软删除”** 设置为 **“禁用”**，选择 **“保存”**，然后关闭 **“安全设置”** 边栏选项卡。


### 练习 2： 借助 Azure Site Recovery 保管库实现 Hyper-V 保护
  
本次练习的主要任务如下：

1. 实现目标 Azure 环境

1. 实现 Hyper-V 虚拟机的保护

1. 对 Hyper-V 虚拟机执行故障转移

1. 删除实验室中部署的 Azure 资源


#### 任务 1：实现目标 Azure 环境

1. 在 Azure 门户中，搜索并选择 **“虚拟网络”**，然后在 **“虚拟网络”** 边栏选项卡上，选择 **“+ 添加”**。

1. 在 **“创建虚拟网络”** 边栏选项卡的 **“基本设置”** 选项卡上，指定以下设置（将其他设置保留为默认值）并选择 **“下一步: IP 地址**：

    | 设置 | 数值 |
    | --- | --- |
    | 订阅 | 在本实验室使用的 Azure 订阅的名称 |
    | 资源组 | 新资源组名称 **az30312c-labRG** |
    | 名称 | **az30312c-dr-vnet** |
    | 区域 | 在本实验室的上一个练习中，将恢复服务保管库署到其中的 Azure 区域的名称。 |

1. 在 **“创建虚拟网络”** 边栏选项卡的 **“IP 地址”** 选项卡上的 **“IPv4 地址空间”** 文本框中，键入 **“10.7.0.0/16”**，然后选择 **“+ 添加子网”**。

1. 在 **“添加子网”** 边栏选项卡上，指定以下设置（将其他设置保留为默认值）并选择 **“添加”**：

    | 设置 | 数值 |
    | --- | --- |
    | 子网名 | **subnet0** |
    | 子网地址范围 | **10.7.0.0/24** |

1. 返回到 **“创建虚拟网络”** 边栏选项卡的 **“IP 地址”** 选项卡，选择 **“查看 + 创建”**。

1. 在 **“创建虚拟网络”** 边栏选项卡的 **“查看 + 创建”** 选项卡上，选择 **“创建”**。

1. 在 Azure 门户中，搜索并选择 **“虚拟网络”**，然后在 **“虚拟网络”** 边栏选项卡上，选择 **“+ 添加”**。

1. 在 **“创建虚拟网络”** 边栏选项卡的 **“基本设置”** 选项卡上，指定以下设置（将其他设置保留为默认值）并选择 **“下一步: IP 地址**：

    | 设置 | 数值 |
    | --- | --- |
    | 订阅 | 在本实验室使用的 Azure 订阅的名称 |
    | 资源组 | **az30312c-labRG** |
    | 名称 | **az30312c-test-vnet** |
    | 区域 | 在本实验室的上一个练习中，将恢复服务保管库署到其中的 Azure 区域的名称。 |

1. 在 **“创建虚拟网络”** 边栏选项卡的 **“IP 地址”** 选项卡上的 **“IPv4 地址空间”** 文本框中，键入 **“10.7.0.0/16”**，然后选择 **“+ 添加子网”**。

1. 在 **“添加子网”** 边栏选项卡上，指定以下设置（将其他设置保留为默认值）并选择 **“添加”**：

    | 设置 | 数值 |
    | --- | --- |
    | 子网名 | **subnet0** |
    | 子网地址范围 | **10.7.0.0/24** |

1. 返回到 **“创建虚拟网络”** 边栏选项卡的 **“IP 地址”** 选项卡，选择 **“查看 + 创建”**。

1. 在 **“创建虚拟网络”** 边栏选项卡的 **“查看 + 创建”** 选项卡上，选择 **“创建”**。

1. 在 Azure 门户中，搜索并选择 **“存储帐户”**，然后在 **“存储帐户”** 边栏选项卡上，选择 **“+ 添加”**。

1. 在 **“创建存储帐户”** 边栏选项卡的 **“基本设置”** 选项卡上，指定以下设置（将其他设置保留为默认值）：

    | 设置 | 数值 | 
    | --- | --- |
    | 订阅 | 在本实验室使用的 Azure 订阅的名称 |
    | 资源组 | **az30312c-labRG** |
    | 存储帐户名称:  | 由字母和数字组成、长度介于 3 到 24 之间的任何全局唯一名称 |
    | 地点 | 本任务初期在其中创建虚拟网络的 Azure 区域的名称 |
    | 性能 | **标准** |
    | 帐户类型： | **StorageV2（常规用途 v2）** |
    | 复制 | **本地冗余存储 (LRS)** |

1. 在 **“创建存储帐户”** 边栏选项卡的 **“基本设置”** 选项卡中，选择 **“查看 + 创建”**

1. 在 **“创建存储帐户”** 边栏选项卡的 **“查看 + 创建”** 选项卡中，选择 **“创建”**。


#### 任务 2：实现 Hyper-V 虚拟机的保护

1. 在 **az30312a-hv-vm** 远程桌面会话中，在 Azure 门户中，在 **“az30312b-rsvault”** 边栏选项卡的 **“开始使用”** 部分，选择 **“Site Recovery”**

1. 在 **“az30312b-rsvault \| Site Recovery”** 边栏选项卡中，在 **“Hyper-V 计算机到 Azure”** 部分，选择 **“1. 准备基础结构”**。 

1. 在 **“准备基础结构”** 边栏选项卡的 **“部署计划”** 选项卡上，在 **“部署计划完成了吗？”** 下拉列表中选择 **“是，我已完成”**，然后选择 **“下一步”**。

1. 在 **“准备基础结构”** 边栏选项卡的 **“源设置”** 选项卡上，选择 **“你是否正在使用 System Center VMM 管理 Hyper-V 主机”** 标签旁的 **“否”** 选项。

1. 在 **“准备基础结构”** 边栏选项卡的 **“源设置”** 选项卡上，选择 **“添加 Hyper-V 站点”** 链接，在 **“创建 Hyper-V 站点”** 边栏选项卡上，在 **“名称”** 文本框中键入 **“az30312b Hyper-V site”**，然后选择 **“确定”**：

1. 在 **“准备基础结构”** 边栏选项卡的 **“源设置”** 选项卡上，选择 **“添加 Hyper-V 服务器”** 链接。 

1. 在 **“添加服务器”** 边栏选项卡中，选择添加本地 Hyper-V 主机过程中步骤 3 的 **“下载”** 链接，以下载 Microsoft Azure Site Recovery 提供程序。

1. 出现提示时，在浏览器窗口中选择 **“运行”**，以启动 **“AzureSiteRecoveryProvider.exe”**。这将启动 **Azure Site Recovery 提供程序安装程序（Hyper-V 服务器）** 向导。

1. 在 **“Microsoft 更新”** 页面上，选择 **“关闭”**，然后选择 **“下一步”**。

1. 在 **“提供程序安装”** 页面上，选择 **“安装”**。

1. 切换到 Azure 门户，然后在 **“添加服务器”** 边栏选项卡上，选择注册本地 Hyper-V 主机过程中步骤 4 的 **“下载”** 按钮，以下载保管库注册密钥。出现提示时，选择 **“保存”**，以将保管库凭据文件保存在 **“Downloads”** 文件夹中。

1. 切换到 **“提供程序安装”** 向导窗口并选择 **“注册”**。这将启动 **Microsoft Azure Site Recovery 注册向导**。

1. 在 **Microsoft Azure Site Recovery 注册向导** 的 **“保管库设置”** 页面上，选择 **“浏览”**，在 **“打开”** 窗口中，导航到 **“Downloads”** 文件夹，选择保管库凭据文件，然后选择 **“打开”**。

1. 返回到 **Microsoft Azure Site Recovery 注册向导** 的 **“保管库设置”** 页面，选择 **“下一步”**。

1. 在 **Microsoft Azure Site Recovery 注册向导** 的 **“代理设置”** 页面 上，接受默认设置，然后选择 **“下一步”**。

1. 在 **Microsoft Azure Site Recovery 注册向导** 的 **“注册”** 页面上，选择 **“完成”**。

1. 切换回显示 Azure 门户的 Internet Explorer 窗口并刷新页面。出现提示时，选择 **“离开页面”**。

1. 返回到 **“az30312b-rsvault | Site Recovery”** 边栏选项卡中，在 **“Hyper-V 计算机到 Azure”** 部分，选择 **“1. 准备基础结构”**。 

1. 在 **“准备基础结构”** 边栏选项卡的 **“部署计划”** 选项卡上，在 **“部署计划完成了吗？”** 下拉列表中选择 **“是，我已完成”**，然后选择 **“下一步”**。

1. 在 **“准备基础结构”** 边栏选项卡的 **“源设置”** 选项卡上，选择 **“你是否正在使用 System Center VMM 管理 Hyper-V 主机”** 标签旁的 **“否”** 选项。

1. 验证 **“Hyper-V 站点”** 和 **“Hyper-V 服务器”** 是否设置正确，然后选择 **“下一步”**。 

1. 在 **“准备基础结构”** 边栏选项卡的 **“目标设置”** 选项卡上，接受默认设置并选择 **“下一步**。

1. 在 **“准备基础结构”** 边栏选项卡的 **“复制策略”** 选项卡上，选择 **“新建策略并关联”**。 

1. 在 **“创建和关联策略”** 边栏选项卡上，指定以下设置（将其他设置保留为默认值）并选择 **“确定”**：

    | 设置 | 数值 |
    | --- | --- |
    | 名称 | **az30312b 复制策略** |
    | 复制频率 | **30 秒** |

1. 回到 **“准备基础结构”** 边栏选项卡的 **“复制策略”** 选项卡上，等待站点与策略相关联，然后选择 **“下一步”**。

1. 在 **“准备基础结构”** 边栏选项卡的 **“查看”** 选项卡上，选择 **“准备”**。

1. 在 **“az30312b-rsvault \| Site Recovery”** 边栏选项上，在 **“Hyper-V 计算机到 Azure”** 部分中选择 **“2. 启用复制”**。 

1. 在 **“启用复制”** 边栏选项卡的 **“源环境”** 选项卡上，在 **“源位置”** 下拉列表中选择 **“az30312b Hyper-V 站点”**，然后选择 **“下一步”**。

1. 在 **“启用复制”** 边栏选项卡的 **“目标环境”** 选项卡上，指定以下设置（将其他设置保留为默认值），然后选择 **“下一步”**：

    | 设置 | 数值 |
    | --- | --- |
    | 订阅 | 在本实验室使用的 Azure 订阅的名称 |
    | 故障转移后的资源组 | **az30312c-labRG** |
    | 故障转移后部署模型 | **资源管理器** |
    | 存储帐户 | 在本练习的第一个任务中创建的存储帐户的名称 |
    | Azure 网络 | 立即为选定的计算机配置 |
    | 故障转移后的 Azure 网络 | **az30312c-dr-vnet** |
    | 子网 | **subnet0 (10.7.0.0/24)** |

1. 在 **“启用复制”** 边栏选项卡的 **“虚拟机选择”** 选项卡上，选择 **“az30312a-vm1”** 复选框并选择 **“下一步”**。

1. 在 **“启用复制”** 边栏选项卡的 **“复制设置”** 选项卡上，在 **“默认值”** 行和 **“OS 类型”** 列中，从下拉列表中选择 **“Windows”**，然后选择 **“下一步”**。

1. 在 **“启用复制”** 边栏选项卡的 **“复制策略”** 选项卡上，接受默认设置并选择 **“下一步”**。

1. 在 **“启用复制”** 边栏选项卡的 **“审阅”** 选项卡上，选择 **“启用复制”**。

#### 任务 3：查看 Azure VM 复制设置

1. 在 Azure 门户中，回到 **“az30312b-rsvault \| Site Recovery”** 边栏选项卡，在垂直菜单中选择 **“复制的项”**。 

1. 在 **“az30312b-rsvault \| 复制的项”** 边栏选项卡上，确保有一个代表 **“az30312a-vm1”** 虚拟机的条目，并验证其 **“复制运行状况”** 是否为 **“正常”** ，其 **“状态”** 是否为 **“正在启用保护”** 或正在显示当前同步进度百分比。

   > **注意**：你可能需要等待几分钟，直到 **“az30312a-vm1”** 条目出现在 **“az30312b-rsvault \| 复制的项”** 边栏选项卡上。

1. 在 **“az30312b-rsvault \| 复制的项”** 边栏选项卡中，选择 **“az30312a-vm1”** 条目。

1. 在 **“az30312a-vm”** 复制的项边栏选项卡上，查看 **“健康状况和状态”**、 **“故障转移就绪”**、 **“最新恢复点”** 和 **“基础结构视图”** 部分。请注意**计划的故障转移**、**故障转移**和**测试故障转移**的工具栏图标。

   > **注意**：等到状态变更为 **“受保护”**。该操作可能还需要 15 分钟。你需要刷新浏览器页面以更新状态。

1. 在 **“az30312a-vm1”** 复制的项边栏选项卡上，选择 **“最新恢复点”**，并查看 **“最新崩溃一致”** 和 **“最新应用一致”** 恢复点。 

#### 任务 4：对 Hyper-V 虚拟机执行故障转移

1. 在与 **“az30312a-vm0”** 的远程桌面会话中，在显示 Azure 门户的浏览器窗口中的 **“az30312a-vm1”** 复制的项边栏选项卡上，选择 **“测试故障转移”**。 

1. 在 **“测试故障转移”** 边栏选项卡上，指定以下设置（将其他设置保留为默认值）并选择 **“确定”**：

    | 设置 | 数值 |
    | --- | --- |
    | 选择恢复点 | 默认选项 | 
    | Azure 虚拟网络 | **az30312c-test-vnet** | 


1. 在 Azure 门户中，导航回到 **“az30312b-rsvault”** 边栏选项卡，并选择 **“Site Recovery 作业”**。保持等待，直到 **“测试故障转移”** 作业的状态被列为 **“成功”**。

1. 在 Azure 门户中，搜索并选择 **“虚拟机”**，在 **“虚拟机”** 边栏选项卡上，注意代表新预配的虚拟机 **“az30312a-vm1-test”** 的条目。

1. 在 Azure 门户中，导航回到 **“az30312a-vm1”** 复制的项边栏选项卡，并选择 **“清除测试故障转移”**。

1. 在 **“测试故障转移清除”** 边栏选项卡上，选择复选框 **“测试完成。删除测试故障转移虚拟机”**，然后选择 **“确定”**。

1. 测试故障转移清除作业完成后，刷新显示 **“az30312a-vm1”** 复制的项边栏选项卡的浏览器页面，注意可以选择执行计划的故障转移和未计划的故障转移。

1. 在 **“az30312a-vm1”** 复制的项边栏选项卡上，选择 **“计划的故障转移”**。 

1. 在 **“计划的故障转移”** 边栏选项卡上，请注意，故障转移方向设置已设置且不可修改。 

1. 关闭 **“计划的故障转移”** 边栏选项卡，然后在 **“az30312a-vm1”** 复制的项边栏选项卡上选择 **“故障转移”**。 

1. 在 **“故障转移”** 边栏选项卡上，请注意旨在最大程度地减少潜在数据丢失的可用选项。 

1. 关闭 **“故障转移”** 边栏选项卡。


#### 任务 4：删除实验室中部署的 Azure 资源

1. 在 **“az30312a-vm0”** 的远程桌面会话中 ，在显示 Azure 门户的浏览器窗口中，在“Cloud Shell”窗格中启动 PowerShell 会话。

1. 在“Cloud Shell”窗格中运行以下命令，以列出你在本练习中创建的资源组：

   ```powershell
   Get-AzResourceGroup -Name 'az30312*'
   ```

    > **注意**：验证输出结果是否仅包含你在本实验室中创建的资源组。在本任务中将删除这个组。

1. 在“Cloud Shell”窗格中运行以下命令，以删除在本实验室中创建的资源组

   ```powershell
   Get-AzResourceGroup -Name 'az30312*' | Remove-AzResourceGroup -Force -AsJob
   ```

1. 关闭“Cloud Shell”窗格。
